#!/usr/bin/env python3
"""

æ•°æ®é‡‡æ ·æ–¹å¼ï¼š
1. å…¨éƒ¨æ•°æ®å¤„ç†ï¼šmax_rows=None, random_sample_size=None
2. å‰Nè¡Œå¤„ç†ï¼šmax_rows=1000, random_sample_size=None  
3. éšæœºæŠ½æ ·Nè¡Œï¼šmax_rows=None, random_sample_size=500
4. å¯é‡å¤éšæœºæŠ½æ ·ï¼šè®¾ç½® random_seed=42ï¼ˆå›ºå®šç§å­ç¡®ä¿æ¯æ¬¡æŠ½æ ·ç»“æœç›¸åŒï¼‰

æ•°æ®ç­›é€‰åŠŸèƒ½ï¼ˆæ–°å¢ï¼‰ï¼š
å¯ä»¥æ ¹æ®æŸä¸ªå­—æ®µçš„å€¼æ¥ç­›é€‰éœ€è¦å¤„ç†çš„æ•°æ®ï¼š
1. ç­›é€‰ç‰¹å®šå€¼ï¼šfilter_column="is_processed", filter_values=[0], filter_condition="in"
2. æ’é™¤ç‰¹å®šå€¼ï¼šfilter_column="is_processed", filter_values=[1], filter_condition="not_in"  
3. ç­‰äºæŸå€¼ï¼šfilter_column="status", filter_values=["pending"], filter_condition="equals"
4. ä¸ç­‰äºæŸå€¼ï¼šfilter_column="status", filter_values=["done"], filter_condition="not_equals"

ç¼“å­˜åŠŸèƒ½ï¼ˆèŠ‚çœAPIæˆæœ¬ï¼‰ï¼š
1. æ™ºèƒ½ç¼“å­˜ï¼šç›¸åŒçš„æ–‡æœ¬å†…å®¹ä¼šè‡ªåŠ¨ä½¿ç”¨ç¼“å­˜ç»“æœï¼Œé¿å…é‡å¤çš„APIè°ƒç”¨
2. ç¼“å­˜æ–‡ä»¶ï¼šé»˜è®¤ä¿å­˜åœ¨ data/cache/llm_analysis_cache.json
3. ç¼“å­˜è¿‡æœŸï¼šå¯ä»¥è®¾ç½®ç¼“å­˜çš„æœ‰æ•ˆæœŸï¼Œé»˜è®¤7å¤©
4. æˆæœ¬èŠ‚çœï¼šé‡å¤å¤„ç†æ—¶ä¼šæ˜¾ç¤ºç¼“å­˜å‘½ä¸­ç‡å’ŒèŠ‚çœçš„APIè°ƒç”¨æ¬¡æ•°

ä½¿ç”¨åœºæ™¯ç¤ºä¾‹ï¼š
- åªå¤„ç†æœªå¤„ç†çš„æ•°æ®ï¼šfilter_column="processed", filter_values=[0, "å¦", "N"], filter_condition="in"
- è·³è¿‡å·²å¤„ç†çš„æ•°æ®ï¼šfilter_column="processed", filter_values=[1, "æ˜¯", "Y"], filter_condition="not_in"

æ³¨æ„ï¼š
- random_sample_size ä¼˜å…ˆçº§é«˜äº max_rows
- ç­›é€‰æ¡ä»¶ä¼šåœ¨é‡‡æ ·ä¹‹å‰åº”ç”¨
- è¾“å‡ºæ–‡ä»¶ä¼šä¿ç•™æ‰€æœ‰åŸå§‹æ•°æ®ï¼Œæœªå¤„ç†çš„è¡Œå¯¹åº”å­—æ®µç•™ç©º
- éšæœºæŠ½æ ·é€‚åˆå¤§æ•°æ®é›†çš„å¿«é€Ÿæµ‹è¯•å’ŒéªŒè¯
- è®¾ç½®éšæœºç§å­å¯ä»¥ç¡®ä¿æŠ½æ ·ç»“æœçš„å¯é‡å¤æ€§
- ç¼“å­˜åŸºäºæ–‡æœ¬å†…å®¹çš„å“ˆå¸Œå€¼ï¼Œç¡®ä¿å†…å®¹å®Œå…¨ç›¸åŒæ‰ä¼šå‘½ä¸­ç¼“å­˜
"""

import asyncio
import logging
import os
from dotenv import load_dotenv
from batch_llm_api import APIConfig, ProcessConfig, LLMBatchProcessor

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# è®¾ç½®ä¸ºINFOçº§åˆ«ï¼Œé¿å…è¿‡å¤šè°ƒè¯•ä¿¡æ¯
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

async def main():
    # ========== é…ç½®åŒºåŸŸ ==========
    
    # 1. APIé…ç½® - ä»ç¯å¢ƒå˜é‡è¯»å–APIå¯†é’¥
    api_key = os.getenv("OPENROUTER_API_KEY")
    if not api_key:
        raise ValueError("è¯·è®¾ç½®ç¯å¢ƒå˜é‡ OPENROUTER_API_KEYï¼Œæˆ–åœ¨.envæ–‡ä»¶ä¸­é…ç½®")
    
    api_config = APIConfig(
        api_key=api_key,  # ğŸ”‘ ä»ç¯å¢ƒå˜é‡è¯»å–APIå¯†é’¥
        model="Pro/deepseek-ai/DeepSeek-V3",                   # ğŸ¤– å¯é€‰çš„æ¨¡å‹
        max_concurrent=100,                        # ğŸš€ å¹¶å‘æ•°ï¼ˆå»ºè®®å…ˆç”¨å°å€¼æµ‹è¯•ï¼‰
        timeout=60,                              # â° è¶…æ—¶æ—¶é—´
        retry_attempts=1,                        # ğŸ”„ é‡è¯•æ¬¡æ•°
        system_prompt="""**è§’è‰²**: ä½ æ˜¯ä¸€åé¡¶å°–çš„æ±½è½¦è¡Œä¸šå®¢æˆ·ä¹‹å£°è§‚ç‚¹æŒ–æ˜ä¸“å®¶ã€‚

**ä»»åŠ¡**: ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯æ·±å…¥ç†è§£æ–‡æœ¬ï¼Œä»ä¸­æç‚¼å‡ºå®¢æˆ·å¯¹äºè½¦è¾†çš„è§‚ç‚¹è¡¨è¾¾ï¼ŒæŠ½å–å‡ºç»“æ„åŒ–çš„è§‚ç‚¹ä¿¡æ¯ï¼Œä¸è¦åˆ†æå®¢æœæˆ–é”€å”®çš„åé¦ˆå’Œæ“ä½œã€‚

### **æ ¸å¿ƒé€»è¾‘ï¼šä»å®è§‚åˆ°å¾®è§‚**

ä½ å¿…é¡»éµå¾ªä»¥ä¸‹ä¸‰ä¸ªå±‚æ¬¡çš„åˆ†æé€»è¾‘ï¼Œå¯¹ä¿¡æ¯çš„æç‚¼è¶Šæ¥è¶Šç²¾ç»†ï¼š
1.  **`category` (åˆ†ç±»)**: æœ€å®è§‚çš„å±‚çº§ï¼Œå°†è§‚ç‚¹å½’å…¥ä¸€ä¸ªå›ºå®šçš„åˆ†ç±»ä¸­ã€‚
2.  **`topic` (ä¸»é¢˜)**: ä¸­é—´å±‚çº§ï¼Œå°†è§‚ç‚¹æç‚¼æˆä¸€ä¸ªæ ‡å‡†åŒ–çš„ã€æ¦‚æ‹¬æ€§çš„è§‚ç‚¹æ ‡ç­¾ã€‚
3.  **`opinion` (è§‚ç‚¹)**: æœ€ç»†åŒ–çš„å±‚çº§ï¼Œç®€çŸ­ç²¾ç¡®æè¿°ç”¨æˆ·çš„åŸå§‹è§‚ç‚¹ã€‚

### **å­—æ®µå®šä¹‰**

è¯·ä¸ºæ–‡æœ¬ä¸­çš„æ¯ä¸€ä¸ªç‹¬ç«‹è§‚ç‚¹ï¼ŒæŠ½å–ä»¥ä¸‹8ä¸ªå­—æ®µï¼š

1.  **`car_brand` (æ±½è½¦å“ç‰Œ)**: æ±½è½¦å“ç‰Œã€‚è‹¥æœªæåŠæˆ–æ— æ³•æ¨æ–­ï¼Œåˆ™è¿”å›ç©ºå­—ç¬¦ä¸² `""`ã€‚
2.  **`car_model` (æ±½è½¦å‹å·)**: å…·ä½“çš„è½¦å‹ã€‚è‹¥æ— ï¼Œåˆ™è¿”å›ç©ºå­—ç¬¦ä¸² `""`ã€‚
3.  **`scenario` (åœºæ™¯)**: è§‚ç‚¹æ‰€å¤„çš„ç‰¹å®šç¯å¢ƒæˆ–æ¡ä»¶ (å¦‚: "é«˜é€Ÿä¸Š")ã€‚è‹¥æ— ï¼Œåˆ™è¿”å›ç©ºå­—ç¬¦ä¸² `""`ã€‚
4.  **`category` (è§‚ç‚¹åˆ†ç±»)**: **ã€å…³é”®å­—æ®µã€‘** ä»ä¸‹æ–¹çš„â€œå›ºå®šæ ‡ç­¾ä½“ç³»â€ä¸­ï¼Œé€šè¿‡ç»„åˆâ€œä¸€çº§åˆ†ç±»æ ‡é¢˜â€å’Œâ€œäºŒçº§åˆ†ç±»åˆ—è¡¨é¡¹â€æ¥æ„å»ºæ­¤å­—æ®µçš„å€¼ã€‚**æœ€ç»ˆè¾“å‡ºæ ¼å¼å¿…é¡»æ˜¯ `"ä¸€çº§åˆ†ç±».äºŒçº§åˆ†ç±»"` çš„ç‚¹åˆ†æ ¼å¼**ã€‚
5.  **`topic` (è§‚ç‚¹æ ‡ç­¾)**: å¯¹è§‚ç‚¹çš„æ ¸å¿ƒå†…å®¹è¿›è¡Œæ¦‚æ‹¬ï¼Œå½¢æˆä¸€ä¸ªæ ‡å‡†åŒ–çš„è§‚ç‚¹æ ‡ç­¾ï¼Œé€šå¸¸ä¾‹å¦‚: "åŠ é€Ÿå¼ºåŠ²", "æ¢æŒ¡é¡¿æŒ«"ã€‚
6.  **`opinion` (æ ¸å¿ƒè§‚ç‚¹)**: ä»åŸæ–‡ä¸­æç‚¼å‡ºçš„ã€èƒ½ç‹¬ç«‹è¡¨è¾¾å®Œæ•´å«ä¹‰çš„ç²¾ç‚¼è§‚ç‚¹ï¼ˆä¾‹å¦‚: "é«˜é€Ÿä¸ŠåŠ é€Ÿå¤Ÿå¼ºæ‚", "åŠ æ¡£å‡æ¡£æœ‰é¡¿æŒ«"ï¼‰ã€‚
7.  **`sentiment` (æƒ…æ„Ÿ)**: è§‚ç‚¹çš„æƒ…æ„Ÿå€¾å‘ã€‚å¿…é¡»æ˜¯ **"æ­£å‘"**, **"è´Ÿå‘"**, **"ä¸­æ€§"** ä¹‹ä¸€ã€‚
8.  **`intent` (æ„å›¾)**: è¡¨è¾¾è€…çš„ç›®çš„ã€‚å¿…é¡»æ˜¯ **"èµæ‰¬"**, **"æŠ±æ€¨"**, **"å»ºè®®"**, **"å’¨è¯¢"**, **"é™ˆè¿°"** ä¹‹ä¸€ã€‚

---

### **å›ºå®šæ ‡ç­¾ä½“ç³» (ç”¨äºæ„å»º `category` å­—æ®µ)**

#### äº§å“ä½“éªŒ
- å¤–è§‚
- å†…é¥°
- ç©ºé—´
- æ€§èƒ½
- ä¸‰ç”µ
- èˆ’é€‚æ€§
- éšç§æ€§
- è´¨é‡å£ç¢‘
- å®‰å…¨æ€§
- ç¯ä¿æ€§
- ç»æµæ€§
- åŠŸèƒ½æ€§
- è½¦å‹é…ç½®
- å……ç”µç›¸å…³

#### å“ç‰Œä½“éªŒ
- å“ç‰Œå®£ä¼ 
- å“ç‰ŒåŠ›

#### æƒç›ŠæœåŠ¡
- è´­è½¦æƒç›Šï¼ˆ4Sï¼‰
- ç”¨è½¦æƒç›Š
- ä¼šå‘˜æƒç›Š
- æ´»åŠ¨æƒç›Š

#### å”®åæœåŠ¡
- è´¨ä¿æœåŠ¡
- æœåŠ¡æµç¨‹
- æ•‘æ´æœåŠ¡
- ç¯å¢ƒå’Œè®¾æ–½
- äººå‘˜è¡¨ç°
- å”®åç²¾å“
- ç»´ä¿®ä¿å…»è´¹ç”¨
- ç»´ä¿®ä¿å…»æ—¶é—´
- ç»´ä¿®ä¿å…»æ•ˆæœ
- å¬å›/æŠ€æœ¯å‡çº§
- æœåŠ¡ä½“éªŒ
- å¹´éªŒæœåŠ¡

#### çº¿ä¸Šè§¦ç‚¹ä½“éªŒ
- APPå•†åŸ
- APPä½¿ç”¨
- è½¦è”ç½‘æœåŠ¡
- å®˜ç½‘
- å®˜æ–¹å¾®åš
- ä¼ä¸šå¾®ä¿¡
- ç›´æ’­
- å¾®ä¿¡å…¬ä¼—å·
- å®¢æœçƒ­çº¿

#### é”€å”®æœåŠ¡
- äº§å“åŠ¨æ€ä½“éªŒ
- äº§å“é™æ€ä½“éªŒ
- å……ç”µè®¾å¤‡
- æœåŠ¡ä½“éªŒ
- è´­ä¹°è¿‡ç¨‹ä½“éªŒ
- ç¯å¢ƒå’Œè®¾æ–½
- å›è®¿åŠå®¢æˆ·å…³æ€€
- äº¤ä»˜ä½“éªŒ
- äºŒæ‰‹è½¦

#### æ™ºèƒ½åŒ–ä½“éªŒ
- æ™ºèƒ½é©¾é©¶
- æ™ºèƒ½åº§èˆ±

---

### **è¾“å‡ºè¦æ±‚**

1.  **æ ¼å¼**: ä¸¥æ ¼æŒ‰ç…§ä¸‹é¢çš„JSONæ ¼å¼ï¼Œç”Ÿæˆä¸€ä¸ªåŒ…å«æ‰€æœ‰å·²æŠ½å–è§‚ç‚¹å¯¹è±¡çš„æ•°ç»„ã€‚
2.  **æœ€ç»ˆè¾“å‡º**: **åªè¿”å›**å®Œæ•´çš„JSONæ•°ç»„å­—ç¬¦ä¸²ã€‚ç¦æ­¢æ·»åŠ ä»»ä½•è§£é‡Šã€æ³¨é‡Šæˆ–å…¶ä»–æ— å…³æ–‡å­—ã€‚

### **ç¤ºä¾‹**

**è¾“å…¥**:
`Cayenneåœ¨é«˜é€Ÿä¸ŠåŠ é€Ÿå¤Ÿå¼ºæ‚ï¼Œæ–¹å‘è½»ï¼ŒåŠ æ¡£å‡æ¡£æœ‰é¡¿æŒ«ï¼Œç»´ä¿®ä¿å…»è´µ`

**è¾“å‡º**:
```json
[
    {"car_brand":"ä¿æ—¶æ·","car_model":"å¡å®´","scenario":"é«˜é€Ÿä¸Š","category":"äº§å“ä½“éªŒ.æ€§èƒ½","topic":"åŠ é€Ÿå¼ºåŠ²","opinion":"åŠ é€Ÿå¤Ÿå¼ºæ‚","sentiment":"æ­£å‘","intent":"èµæ‰¬"},
    {"car_brand":"ä¿æ—¶æ·","car_model":"å¡å®´","scenario":"","category":"äº§å“ä½“éªŒ.æ€§èƒ½","topic":"æ–¹å‘ç›˜æ‰‹æ„Ÿè½»å·§","opinion":"æ–¹å‘è½»","sentiment":"æ­£å‘","intent":"èµæ‰¬"},
    {"car_brand":"ä¿æ—¶æ·","car_model":"å¡å®´","scenario":"","category":"äº§å“ä½“éªŒ.æ€§èƒ½","topic":"æ¢æŒ¡é¡¿æŒ«","opinion":"åŠ æ¡£å‡æ¡£æœ‰é¡¿æŒ«","sentiment":"è´Ÿå‘","intent":"æŠ±æ€¨"},
    {"car_brand":"ä¿æ—¶æ·","car_model":"å¡å®´","scenario":"","category":"å”®åæœåŠ¡.ç»´ä¿®ä¿å…»è´¹ç”¨","topic":"ç»´ä¿®ä¿å…»è´¹ç”¨é«˜","opinion":"ç»´ä¿®ä¿å…»è´µ","sentiment":"è´Ÿå‘","intent":"æŠ±æ€¨"}
]""",  # ğŸ­ ç³»ç»Ÿæç¤ºè¯
        # ğŸ’¾ ç¼“å­˜é…ç½® - èŠ‚çœAPIè°ƒç”¨æˆæœ¬
        enable_cache=True,                       # ğŸ”§ å¯ç”¨ç¼“å­˜åŠŸèƒ½
        cache_file="data/cache/llm_analysis_cache.json",  # ğŸ“ ç¼“å­˜æ–‡ä»¶è·¯å¾„
        cache_ttl=7*24*3600,                     # â³ ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆ7å¤©ï¼‰ï¼ŒNoneè¡¨ç¤ºæ°¸ä¸è¿‡æœŸ
    )
    
    # 2. å¤„ç†é…ç½®
    process_config = ProcessConfig(
        input_csv="/Users/hanzhang/Projects/qwen-sft/original_text.csv",               # ğŸ“ è¾“å…¥æ–‡ä»¶
        output_csv="/Users/hanzhang/Projects/qwen-sft/original_text_results-deepseek.csv",                # ğŸ“ è¾“å‡ºæ–‡ä»¶
        input_column="text",                     # ğŸ“ è¦å¤„ç†çš„åˆ—å
        
        # ğŸ“‹ Promptæ¨¡æ¿ - æ ¹æ®æ‚¨çš„éœ€æ±‚ä¿®æ”¹
        prompt_template="""è¯·åˆ†æä»¥ä¸‹æ–‡æœ¬å†…å®¹ï¼Œå¹¶æŒ‰ç…§è¦æ±‚è¾“å‡ºJSONæ ¼å¼ã€‚

è¾“å…¥æ–‡æœ¬å†…å®¹ï¼š{input_text}
""",
        
        # ğŸ“Š è¦æå–çš„JSONå­—æ®µ
        output_json_fields=["car_brand", "car_model", "scenario", "category", "topic", "opinion", "sentiment", "intent"],
        
        # ğŸ² æ•°æ®é‡‡æ ·é…ç½®ï¼ˆå¯é€‰ï¼‰
        max_rows=5000,  # ğŸ”¢ æŒ‰é¡ºåºå–å‰Nè¡Œï¼ŒNoneè¡¨ç¤ºä¸é™åˆ¶
        random_sample_size=None,  # ğŸ¯ éšæœºæŠ½æ ·Nè¡Œè¿›è¡Œå¤„ç†ï¼ŒNoneè¡¨ç¤ºä¸æŠ½æ ·
        random_seed=42,  # ğŸŒ± éšæœºç§å­ï¼Œç¡®ä¿æŠ½æ ·ç»“æœå¯é‡å¤ï¼ˆå¯é€‰ï¼‰
        
        # ğŸ” æ•°æ®ç­›é€‰é…ç½®ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰
        # ç¤ºä¾‹1ï¼šåªå¤„ç†æ ‡è®°ä¸ºéœ€è¦å¤„ç†çš„æ•°æ®
        # filter_column="need_process",  # ğŸ“‹ ç­›é€‰å­—æ®µå
        # filter_values=[1, "æ˜¯", "Y", "yes"],  # ğŸ“ ç­›é€‰å€¼åˆ—è¡¨ï¼ˆåŒ…å«è¿™äº›å€¼çš„è¡Œä¼šè¢«å¤„ç†ï¼‰
        # filter_condition="in",  # ğŸ“ ç­›é€‰æ¡ä»¶
        
        # ç¤ºä¾‹2ï¼šè·³è¿‡å·²ç»å¤„ç†è¿‡çš„æ•°æ®  
        # filter_column="is_processed",
        # filter_values=[1, "å·²å¤„ç†", "done"],
        # filter_condition="not_in",
        
        filter_column=None,  # ğŸ“‹ è®¾ç½®ä¸ºNoneè¡¨ç¤ºä¸ä½¿ç”¨ç­›é€‰ï¼Œå¤„ç†æ‰€æœ‰æ•°æ®
        filter_values=[1],  # ğŸ“ ç­›é€‰å€¼åˆ—è¡¨
        filter_condition="in",  # ğŸ“ ç­›é€‰æ¡ä»¶ï¼š'in'åŒ…å«, 'not_in'ä¸åŒ…å«, 'equals'ç­‰äº, 'not_equals'ä¸ç­‰äº
        
        jsonl_file="llm_results_progress.jsonl",  # ğŸ“ é˜¶æ®µæ€§ä¿å­˜çš„jsonlæ–‡ä»¶
        batch_size=100  # ğŸ”„ æ¯30è¡Œä¿å­˜ä¸€æ¬¡
    )
    
    # ========== æ‰§è¡Œå¤„ç† ==========
    
    print("ğŸš€ å¼€å§‹æ‰¹é‡å¤„ç†...")
    print(f"ğŸ“ è¾“å…¥æ–‡ä»¶: {process_config.input_csv}")
    print(f"ğŸ“ è¾“å‡ºæ–‡ä»¶: {process_config.output_csv}")
    print(f"ğŸ¤– ä½¿ç”¨æ¨¡å‹: {api_config.model}")
    print(f"ğŸ”„ æœ€å¤§å¹¶å‘: {api_config.max_concurrent}")
    
    # æ˜¾ç¤ºç¼“å­˜é…ç½®
    if api_config.enable_cache:
        print(f"ğŸ’¾ ç¼“å­˜åŠŸèƒ½: å·²å¯ç”¨")
        print(f"ğŸ“ ç¼“å­˜æ–‡ä»¶: {api_config.cache_file}")
        if api_config.cache_ttl:
            print(f"â³ ç¼“å­˜æœŸé™: {api_config.cache_ttl//3600//24} å¤©")
        else:
            print(f"â³ ç¼“å­˜æœŸé™: æ°¸ä¸è¿‡æœŸ")
    else:
        print("ğŸ’¾ ç¼“å­˜åŠŸèƒ½: å·²ç¦ç”¨")
    
    # æ˜¾ç¤ºæ•°æ®ç­›é€‰é…ç½®
    if process_config.filter_column:
        print(f"ğŸ” æ•°æ®ç­›é€‰: {process_config.filter_column} {process_config.filter_condition} {process_config.filter_values}")
    else:
        print("ğŸ” æ•°æ®ç­›é€‰: æ— ç­›é€‰ï¼Œå¤„ç†æ‰€æœ‰æ•°æ®")
    
    # æ˜¾ç¤ºæ•°æ®é‡‡æ ·é…ç½®
    if process_config.random_sample_size:
        print(f"ğŸ¯ éšæœºæŠ½æ ·: {process_config.random_sample_size} è¡Œ")
        if process_config.random_seed is not None:
            print(f"ğŸŒ± éšæœºç§å­: {process_config.random_seed}")
    elif process_config.max_rows:
        print(f"ğŸ”¢ é™åˆ¶è¡Œæ•°: å‰ {process_config.max_rows} è¡Œ")
    else:
        print("ğŸ“Š å¤„ç†æ¨¡å¼: å…¨éƒ¨æ•°æ®")
    
    print("-" * 50)
    
    try:
        async with LLMBatchProcessor(api_config, process_config) as processor:
            result_df = await processor.process_batch()
            processor.save_results(result_df)
            
            # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            total_rows = len(result_df)
            success_rows = len(result_df[result_df['parsing_success'] == True])
            success_rate = success_rows / total_rows * 100 if total_rows > 0 else 0
            
            print("-" * 50)
            print("âœ… å¤„ç†å®Œæˆï¼")
            print(f"ğŸ“Š æ€»å¤„ç†è¡Œæ•°: {total_rows}")
            print(f"âœ… æˆåŠŸå¤„ç†: {success_rows}")
            print(f"ğŸ“ˆ æˆåŠŸç‡: {success_rate:.1f}%")
            print(f"ğŸ“ ç»“æœå·²ä¿å­˜åˆ°: {process_config.output_csv}")
            print(f"ğŸ“ è¿›åº¦æ–‡ä»¶: {process_config.jsonl_file}")
            
            # æ˜¾ç¤ºå‰å‡ è¡Œç»“æœé¢„è§ˆ
            if len(result_df) > 0:
                print("\nğŸ“‹ ç»“æœé¢„è§ˆ:")
                for field in process_config.output_json_fields:
                    if field in result_df.columns:
                        print(f"  {field}: {result_df[field].dropna().head(3).tolist()}")
            
            # è¯¢é—®æ˜¯å¦æ¸…ç†jsonlæ–‡ä»¶
            print(f"\nğŸ’¡ æç¤º: è¿›åº¦æ–‡ä»¶ {process_config.jsonl_file} å·²å®Œæˆä½¿å‘½")
            print("   æ‚¨å¯ä»¥æ‰‹åŠ¨åˆ é™¤å®ƒï¼Œæˆ–ä¿ç•™ä½œä¸ºå¤‡ä»½")
            print("   å¦‚éœ€é‡æ–°å¤„ç†ï¼Œè¯·å…ˆåˆ é™¤æ­¤æ–‡ä»¶ä»¥é¿å…è·³è¿‡å·²å¤„ç†æ•°æ®")
            
    except Exception as e:
        print(f"âŒ å¤„ç†å¤±è´¥: {e}")
        print("ğŸ’¡ è¯·æ£€æŸ¥:")
        print("  1. APIå¯†é’¥æ˜¯å¦æ­£ç¡®")
        print("  2. è¾“å…¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨")
        print("  3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸")
        print("  4. APIé…é¢æ˜¯å¦å……è¶³")

if __name__ == "__main__":
    print("ğŸ¯ æ‰¹é‡LLM APIè°ƒç”¨è„šæœ¬")
    print("=" * 50)
    
    # # æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®æ”¹é…ç½®
    # import os
    # if not os.path.exists("test_data.csv"):
    #     print("âš ï¸  æµ‹è¯•æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºtest_data.csv")
    #     print("å¯ä»¥ä½¿ç”¨æä¾›çš„test_data.csvä½œä¸ºç¤ºä¾‹")
    #     exit(1)
    
    # print("âš ï¸  è¯·ç¡®ä¿å·²ä¿®æ”¹quick_start.pyä¸­çš„APIå¯†é’¥ï¼")
    # input("æŒ‰å›è½¦é”®ç»§ç»­...")
    
    # è¿è¡Œä¸»ç¨‹åº
    asyncio.run(main()) 